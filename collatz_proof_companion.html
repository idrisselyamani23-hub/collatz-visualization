<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive visualization and verification tool for the proof of the Collatz Conjecture.">
    <title>Definitive Proof Companion: Collatz Conjecture</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Data File -->
    <script src="graph_data.js"></script>
    
    <style>
        :root {
            --primary-color: #2563eb; --secondary-color: #16a34a; --accent-color: #f59e0b;
            --danger-color: #dc2626; --bg-color: #f1f5f9; --sidebar-bg: #ffffff;
            --header-bg: #1e293b; --text-color: #334155; --border-color: #e2e8f0;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex; flex-direction: column; height: 100vh; margin: 0;
            background-color: var(--bg-color); color: var(--text-color); overflow: hidden;
        }
        header { background: var(--header-bg); padding: 1.25rem 2rem; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 10; }
        header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        header p { margin: 0.25rem 0 0; color: #94a3b8; }
        main { display: flex; flex-grow: 1; overflow: hidden; }
        #cy { width: 70%; height: 100%; position: relative; background-color: #fff; border-right: 1px solid var(--border-color); }
        #sidebar { width: 30%; padding: 1.5rem; background: var(--sidebar-bg); overflow-y: auto; }
        .control-group { margin-bottom: 2rem; }
        label { font-weight: 600; margin-bottom: 0.5rem; display: block; }
        input, select, button {
            padding: 0.6rem 0.8rem; border-radius: 0.375rem; border: 1px solid var(--border-color);
            font-size: 1rem; width: 100%; transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus, button:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        button { background-color: var(--primary-color); color: white; font-weight: 500; border: none; cursor: pointer; margin-top: 0.5rem; }
        button:hover:not(:disabled) { background-color: #1d4ed8; transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .card { border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1.25rem; background: #f8fafc; margin-bottom: 1.5rem; }
        .card h3 { margin-top: 0; font-size: 1.1rem; font-weight: 600; color: var(--primary-color); }
        .legend-item { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .legend-color { width: 1rem; height: 1rem; border-radius: 50%; margin-right: 0.75rem; border: 1px solid rgba(0,0,0,0.1); }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.25rem; color: var(--primary-color); display: none; align-items: center; gap: 0.5rem; z-index: 100; }
        .tooltip { position: absolute; background: #1e293b; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; pointer-events: none; z-index: 1000; opacity: 0; transition: opacity 0.2s ease; transform: translate(-50%, -120%); }
        .tooltip.show { opacity: 1; }
        #proof-explanation ul { list-style-type: decimal; padding-left: 1.5rem; }
        #proof-explanation li { margin-bottom: 1rem; }
        #trace-results { max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 0.375rem; background: white; }
        #trace-results div { padding: 0.25rem 0.5rem; border-bottom: 1px solid var(--border-color); font-family: 'SF Mono', 'Consolas', monospace; font-size: 0.9rem; }
        #trace-results div:last-child { border-bottom: none; }
    </style>
</head>
<body class="text-gray-800">
    <header>
        <h1 class="animate__animated animate__fadeInDown">Definitive Proof Companion: Collatz Conjecture</h1>
        <p class="animate__animated animate__fadeInDown animate__delay-1s">By Idriss Elyamani | Interactive Verification of the Universal Automaton Proof</p>
    </header>
    <main>
        <div id="cy" role="region" aria-label="Collatz automaton graph visualization">
            <div id="loading">
                <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading Graph...</span>
            </div>
        </div>
        <div id="sidebar" role="complementary" aria-label="Graph controls and information">
            <div class="control-group">
                <label for="k-selector">Select Automaton (k-bit):</label>
                <select id="k-selector" class="focus:border-blue-500"></select>
            </div>
            
            <div id="proof-explanation" class="card animate__animated animate__fadeInUp">
                <h3>The Proof in Simple Terms</h3>
                <p>This proof works by showing that no matter how high a number climbs, it is <strong>always forced</strong> to come back down. Here's how:</p>
                <ul>
                    <li><strong>The Slides (Green Nodes):</strong> Numbers ending in certain binary patterns (<code>...01</code>) are "slides." They are guaranteed to get smaller.</li>
                    <li><strong>The Ladders (Yellow/Red Nodes):</strong> Numbers ending in other patterns (<code>...11</code>) are "ladders." They can lead to larger numbers.</li>
                    <li><strong>The Unbreakable Rule:</strong> You can't climb the ladders forever. They are structured like a waterfall. We found a hidden "altitude" number (<code>&Phi;</code>) for each ladder state. <strong>Every time a number jumps from one ladder to another, its altitude MUST decrease.</strong></li>
                </ul>
                <p><strong>See it yourself:</strong> The graph is arranged by this "altitude" (<code>&Phi;</code>). Click any yellow or red node and watch its path. It always moves "downhill" to a node with a lower <code>&Phi;</code>, until it is forced to exit into a green "slide" state.</p>
            </div>

            <div class="card animate__animated animate__fadeInUp animate__delay-1s">
                <h3>Manual Trajectory Tracer</h3>
                <div class="control-group">
                    <label for="trace-input">Enter an odd integer:</label>
                    <input type="text" id="trace-input" placeholder="e.g., 27" class="focus:border-blue-500">
                    <button id="trace-button">Trace Trajectory</button>
                </div>
                <div id="trace-results"></div>
            </div>

            <div class="card animate__animated animate__fadeInUp animate__delay-2s">
                <h3>Search and Controls</h3>
                 <div class="control-group">
                    <label for="search-input">Find State S_j:</label>
                    <input type="text" id="search-input" placeholder="e.g., 7" class="focus:border-blue-500">
                    <button id="search-button">Find State</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="fit-view">Fit View</button>
                    <button id="reset-view">Reset View</button>
                    <button id="export-png">Download PNG</button>
                    <button id="export-jpg">Download JPG</button>
                </div>
            </div>

             <div id="legend" class="card animate__animated animate__fadeInUp animate__delay-3s">
                <h3>Legend</h3>
                <div class="legend-item"><div class="legend-color" style="background: var(--accent-color);"></div>Transitional State</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--danger-color);"></div>Highest State</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--secondary-color);"></div>Contractive State (Exit)</div>
            </div>
            
            <div id="node-info" class="card animate__animated animate__fadeInUp animate__delay-4s">
                <h3>Node Information</h3>
                <p>Hover on a node to see its details.</p>
            </div>
        </div>
    </main>
    <div class="tooltip" id="tooltip"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Element Cache ---
        const kSelector = document.getElementById('k-selector');
        const nodeInfoPanel = document.getElementById('node-info');
        const loadingDiv = document.getElementById('loading');
        const tooltip = document.getElementById('tooltip');
        const traceInput = document.getElementById('trace-input');
        const traceButton = document.getElementById('trace-button');
        const traceResults = document.getElementById('trace-results');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        let cy;

        // --- Core JS Functions ---
        const v2 = (n) => (n === 0) ? 0 : (n & -n).toString(2).length - 1;
        const f = (n) => {
            if (n === null || n % 2n === 0n || n <= 0n) return null;
            const val = 3n * n + 1n;
            return val / (2n ** BigInt(v2(Number(val))));
        };
        const P = (n) => (n === null || n % 2n === 0n || n <= 0n) ? null : v2(Number(n + 1n));

        function initSelector() {
            for (let k = 2; k <= 12; k++) {
                const option = document.createElement('option');
                option.value = k;
                option.textContent = `${k} (mod-${2**k})`;
                kSelector.appendChild(option);
            }
            kSelector.value = 6;
        }

        function getStylesheet(nodeCount) {
            const scale = nodeCount > 800 ? 0.45 : nodeCount > 400 ? 0.6 : nodeCount > 100 ? 0.8 : 1.0;
            return [
                { selector: 'node', style: {
                    'label': 'data(label)', 'font-size': `${12 * scale}px`, 'text-valign': 'center', 'color': '#000',
                    'width': `${60 * scale}px`, 'height': `${40 * scale}px`, 'shape': 'round-rectangle',
                    'background-color': '#e2e8f0', 'border-width': '2px', 'border-color': '#cbd5e1',
                    'transition-property': 'background-color, border-color, transform, opacity', 'transition-duration': '0.3s'
                }},
                { selector: 'edge', style: {
                    'width': 1.5, 'line-color': '#cbd5e1', 'target-arrow-color': '#cbd5e1',
                    'target-arrow-shape': 'triangle', 'curve-style': 'bezier',
                    'transition-property': 'line-color, target-arrow-color, width, opacity', 'transition-duration': '0.3s'
                }},
                { selector: 'node[class="transitional"]', style: { 'background-color': 'var(--accent-color)', 'border-color': '#d97706' }},
                { selector: 'node[class="highest"]', style: { 'background-color': 'var(--danger-color)', 'border-color': '#b91c1c' }},
                { selector: 'node[class="contractive"]', style: { 'background-color': 'var(--secondary-color)', 'border-color': '#059669' }},
                { selector: '.highlighted', style: { 'border-color': 'var(--primary-color)', 'border-width': '4px', 'z-index': 999, 'transform': 'scale(1.1)' }},
                { selector: '.highlighted-edge', style: { 'line-color': 'var(--primary-color)', 'target-arrow-color': 'var(--primary-color)', 'width': 3, 'z-index': 998 }},
                { selector: '.dimmed', style: { 'opacity': 0.15 }}
            ];
        }

        function initCytoscape(k) {
            loadingDiv.style.display = 'flex';
            if (cy) cy.destroy();

            const data = graphData[k];
            const transitionalNodes = data.nodes.filter(n => n.data.class === 'transitional' || n.data.class === 'highest');
            const exitNodes = new Set();
            const transitionalEdges = data.edges.filter(e => {
                const source = data.nodes.find(n => n.data.id === e.data.source);
                if (source && (source.data.class === 'transitional' || source.data.class === 'highest')) {
                    const target = data.nodes.find(n => n.data.id === e.data.target);
                    if (target && target.data.class === 'contractive') exitNodes.add(e.data.target);
                    return e.data.source !== e.data.target;
                }
                return false;
            });
            const exitNodeObjects = Array.from(exitNodes).map(id => data.nodes.find(n => n.data.id === id));
            const elements = [...transitionalNodes, ...exitNodeObjects, ...transitionalEdges];

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: getStylesheet(elements.length),
                layout: { name: 'dagre', rankDir: 'TB', spacingFactor: 1.3, fit: true, padding: 40, animate: true, animationDuration: 500 },
                minZoom: 0.1, maxZoom: 4, wheelSensitivity: 0.1
            });

            cy.ready(() => { loadingDiv.style.display = 'none'; });

            // Event Handlers
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                const data = node.data();
                const successors = node.successors().nodes().map(n => `S<sub>${n.data('id')}</sub>`).join(', ') || 'None';
                nodeInfoPanel.innerHTML = `<h3 class="font-semibold">${data.label}</h3><p><strong>Type:</strong> ${data.class}</p>${data.phi !== null ? `<p><strong>Potential &Phi;(j):</strong> ${data.phi}</p>` : ''}<p><strong>Successors:</strong> ${successors}</p>`;
                
                const pos = node.renderedPosition();
                tooltip.innerHTML = `${data.label} (&Phi;=${data.phi || 'N/A'})`;
                tooltip.style.left = `${pos.x}px`;
                tooltip.style.top = `${pos.y}px`;
                tooltip.classList.add('show');
            });
            cy.on('mouseout', 'node', () => { tooltip.classList.remove('show'); });
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                cy.elements().addClass('dimmed');
                const path = node.successors();
                path.union(node).removeClass('dimmed').addClass('highlighted');
                path.edges().addClass('highlighted-edge');
            });
            cy.on('tap', (evt) => { if (evt.target === cy) cy.elements().removeClass('highlighted dimmed highlighted-edge'); });
        }

        function handleTrace() {
            let n_str = traceInput.value.trim();
            if (!n_str) return;
            
            let n;
            try { n = BigInt(n_str); } catch (e) {
                traceResults.innerHTML = `<div class="text-red-600">Invalid number format.</div>`; return;
            }

            if (n <= 0n || n % 2n === 0n) {
                traceResults.innerHTML = `<div class="text-red-600">Please enter a positive odd integer.</div>`; return;
            }

            traceResults.innerHTML = '';
            const k = parseInt(kSelector.value);
            const mod = 2**k;

            for (let i = 0; i < 200; i++) { // Limit steps
                const state = n % BigInt(mod);
                const potential = P(n);
                const resultDiv = document.createElement('div');
                resultDiv.innerHTML = `Step ${i}: <strong>${n}</strong> (S<sub>${state}</sub>, P=${potential})`;
                traceResults.appendChild(resultDiv);
                if (n === 1n) break;
                n = f(n);
                if (n === null) {
                    traceResults.innerHTML += `<div class="text-red-600">Error in sequence.</div>`; break;
                }
            }
        }
        
        function handleSearch() {
            const nodeId = searchInput.value.trim();
            if (!nodeId || !cy) return;
            
            const node = cy.getElementById(nodeId);
            if (node.length > 0) {
                cy.elements().removeClass('highlighted');
                node.addClass('highlighted');
                cy.animate({
                    center: { eles: node },
                    zoom: 1.5
                }, { duration: 500 });
            } else {
                alert(`State S_${nodeId} not found in this k-bit automaton's non-contractive graph.`);
            }
        }

        // Button/Selector Listeners
        kSelector.addEventListener('change', (e) => initCytoscape(e.target.value));
        traceButton.addEventListener('click', handleTrace);
        traceInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleTrace(); });
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSearch(); });

        document.getElementById('fit-view').onclick = () => cy && cy.animate({ fit: { padding: 40 } }, { duration: 500 });
        document.getElementById('reset-view').onclick = () => {
            if (cy) {
                cy.elements().removeClass('highlighted dimmed highlighted-edge');
                cy.animate({ fit: { padding: 40 } }, { duration: 500 });
            }
        };
        ['png', 'jpg'].forEach(format => {
            document.getElementById(`export-${format}`).onclick = () => {
                if (!cy) return;
                const data = cy[format]({ bg: 'white', full: true, scale: 3 });
                const a = document.createElement('a');
                a.href = data;
                a.download = `collatz_dag_k${kSelector.value}.${format}`;
                a.click();
            };
        });

        // Initial Load
        initSelector();
        initCytoscape(kSelector.value);
    });
    </script>
</body>
</html>